# TikTok 弹幕获取工具使用说明

## 问题解决

### 为什么浏览器设置了本地18080代理但代码无法收到浏览器请求？

**原因分析：**
1. 您的代码在端口 `23809` 上启动了 SunnyNet 代理服务器
2. 但在端口 `18080` 上启动了 HTTP/WebSocket 服务器
3. 浏览器设置代理为 `127.0.0.1:18080`，但这个端口运行的是 WebSocket 服务器，不是代理服务器

**解决方案：**
- 浏览器应该设置代理为 `127.0.0.1:23809`（SunnyNet 代理端口）
- WebSocket 服务器运行在 `127.0.0.1:18080`（用于接收弹幕数据）

## 正确的配置步骤

### 1. 启动程序
```bash
go run main.go struct.go
```

### 2. 浏览器代理设置
- **代理地址：** `127.0.0.1:23809`
- **代理类型：** HTTP/HTTPS 代理
- **端口：** 23809

### 3. 测试连接
1. 打开浏览器，访问 `test.html` 文件
2. 点击"测试代理连接"按钮
3. 如果显示"代理测试成功"，说明代理配置正确

### 4. 连接 WebSocket
1. 在测试页面点击"连接 WebSocket"按钮
2. 如果显示"WebSocket 连接成功"，说明 WebSocket 服务正常

## 端口说明

| 端口 | 用途 | 说明 |
|------|------|------|
| 23809 | SunnyNet 代理服务器 | 浏览器需要设置此端口作为代理 |
| 18080 | WebSocket 服务器 | 用于接收和显示弹幕数据 |
| 21586 | 上游代理 | 您的上游代理服务器 |

## 工作流程

1. **浏览器设置代理** → `127.0.0.1:23809`
2. **访问 TikTok 直播** → 流量通过 SunnyNet 代理
3. **SunnyNet 拦截 TikTok 数据** → 在 `WSCallback` 中处理
4. **解析弹幕数据** → 转换为 JSON 格式
5. **发送到 WebSocket 客户端** → 端口 18080
6. **前端显示弹幕** → 实时显示在网页上

## 常见问题

### Q: 为什么收不到 TikTok 数据？
A: 请检查：
1. 浏览器代理是否正确设置为 `127.0.0.1:23809`
2. 上游代理 `127.0.0.1:21586` 是否正常工作
3. 是否正在访问 TikTok 直播页面

### Q: WebSocket 连接失败怎么办？
A: 请检查：
1. 程序是否正常启动
2. 端口 18080 是否被其他程序占用
3. 防火墙是否阻止了连接

### Q: 代理测试失败怎么办？
A: 请检查：
1. SunnyNet 代理是否正常启动
2. 上游代理是否可用
3. 网络连接是否正常

## 调试技巧

1. **查看控制台输出**：程序会显示详细的连接信息
2. **使用测试页面**：`test.html` 可以帮助诊断问题
3. **检查端口占用**：
   ```bash
   # Windows
   netstat -ano | findstr :23809
   netstat -ano | findstr :18080
   
   # Linux/Mac
   lsof -i :23809
   lsof -i :18080
   ```

## 代码结构

- `main.go` - 主程序，包含代理服务器和 WebSocket 服务器
- `struct.go` - 数据结构定义
- `test.html` - 测试页面
- `tiktok_hack/` - TikTok 协议解析相关代码

## 注意事项

1. 确保上游代理服务器 `127.0.0.1:21586` 正常运行
2. 不要同时运行多个实例，避免端口冲突
3. 如果修改端口，需要同时更新浏览器代理设置
4. 建议在测试环境中使用，避免影响正常网络访问
